<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>토스페이먼츠 결제 예시</title>
    <!-- 토스페이먼츠 결제위젯 SDK -->
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 400px;
            max-width: 90%;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        .input-group input, .input-group select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #3182f6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }
        button:hover {
            background-color: #1a6ddb;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
            text-align: left;
            word-break: break-all;
        }
        #result.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        #result.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
    </style>

</head>
<body>
    <div class="container">
        <h1>토스페이먼츠 결제 테스트</h1>

        <div class="input-group">
            <label for="purchaseId">구매 ID (백엔드에서 생성된)</label>
            <input type="number" id="purchaseId" value="1" placeholder="구매 ID">
        </div>
        <div class="input-group">
            <label for="amount">결제 금액</label>
            <input type="number" id="amount" value="15000" placeholder="결제 금액">
        </div>
        <div class="input-group">
            <label for="paymentType">결제 타입</label>
            <select id="paymentType">
                <option value="PAYMENT">PAYMENT</option>
                <!-- 필요에 따라 다른 PaymentType 추가 -->
            </select>
        </div>

        <button id="payButton">결제하기</button>

        <div id="result">
            결제 결과가 여기에 표시됩니다.
        </div>
    </div>

    <script>

        const clientKey = 'test_ck_P9BRQmyarYg55ZeE5b5X3J07KzLN';
        const tossPayments = TossPayments(clientKey);

        // --- 수정 부분 시작 ---
        // 여기에 JWT 토큰을 넣습니다.
        const JWT_TOKEN = 'eyJkYXRlIjoxNzY1MjYyMTQyNzE4LCJ0eXBlIjoiand0IiwiYWxnIjoiSFMyNTYifQ.eyJzdWIiOiJvaGdpcmFmZmVycyB0b2tlbiA6IDk1Iiwicm9sZSI6IlVTRVIiLCJleHAiOjE3NjUyNjU3NDIsImVtYWlsIjoidGVzdHVzZXIwMUBleGFtcGxlLmNvbSJ9.x5WwivQx9UYqN07ejpIJG2S-fh0tplqCAEoN6Tdm_QU';
        // --- 수정 부분 끝 ---

        const payButton = document.getElementById('payButton');
        const purchaseIdInput = document.getElementById('purchaseId');
        const amountInput = document.getElementById('amount');
        const paymentTypeSelect = document.getElementById('paymentType');
        const resultDiv = document.getElementById('result');

        payButton.addEventListener('click', async () => {
            const purchaseId = parseInt(purchaseIdInput.value);
            const amount = parseInt(amountInput.value);
            const paymentType = paymentTypeSelect.value;

            if (!purchaseId || !amount || !paymentType) {
                displayResult('error', '모든 필드를 입력해주세요.');
                return;
            }

            displayResult('info', '결제 초기화 중...');

            try {
                // 1. 백엔드에 결제 초기화 요청 (POST /api/v1/payments/initiate)
                const initiateResponse = await fetch('/api/v1/payments/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // --- 수정 부분 시작 ---
                        'Authorization': `Bearer ${JWT_TOKEN}` // <-- 이 줄을 추가하거나 수정합니다.
                        // --- 수정 부분 끝 ---
                        // 'X-CSRF-TOKEN': 'YOUR_CSRF_TOKEN' // CSRF 보호가 활성화된 경우 필요
                    },
                    body: JSON.stringify({
                        purchaseId: purchaseId,
                        amount: amount,
                        paymentType: paymentType
                    })
                });

                const initiateData = await initiateResponse.json();

                if (initiateResponse.ok && initiateData.status === 'CREATED') {
                    const backendPaymentId = initiateData.data.paymentId;
                    displayResult('info', `백엔드 결제 초기화 성공. Payment ID: ${backendPaymentId}. 토스페이먼츠 결제창 호출...`);

                    // 2. 토스페이먼츠 결제창 호출
                    await tossPayments.requestPayment({
                        method: '카드', // 결제 수단 (예: '카드', '가상계좌', '계좌이체' 등)
                        amount: amount,
                        orderId: String(backendPaymentId), // 백엔드에서 생성된 Payment ID를 orderId로 사용
                        orderName: `상품 ${purchaseId}번 외 ${amount}원`, // 실제 주문명으로 변경
                        customerName: '테스트 구매자', // 실제 구매자명으로 변경
                        successUrl: window.location.origin + '/api/v1/payments/confirm', // 백엔드 confirm 엔드포인트
                        failUrl: window.location.origin + '/fail' // 결제 실패 시 리다이렉트될 URL (프론트엔드에서 처리)
                    });

                } else {
                    displayResult('error', `결제 초기화 실패: ${initiateData.message || '알 수 없는 오류'}`);
                }

            } catch (error) {
                console.error('결제 처리 중 오류 발생:', error);
                displayResult('error', `결제 처리 중 오류 발생: ${error.message || '네트워크 오류'}`);
            }
        });

        function displayResult(type, message) {
            resultDiv.className = '';
            resultDiv.classList.add(type);
            resultDiv.textContent = message;
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('code') && urlParams.has('message')) {
            displayResult('error', `결제 실패: ${urlParams.get('message')} (코드: ${urlParams.get('code')})`);
        }
    </script>
</body>
</html>