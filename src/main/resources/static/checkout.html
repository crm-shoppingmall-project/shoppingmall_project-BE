<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²°ì œ í…ŒìŠ¤íŠ¸ , Checkout</title>
</head>
<body>
<h1>ê²°ì œ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>

<!-- JWT ì…ë ¥ -->
<div>
    <label>Access Token(JWT): </label>
    <input id="accessToken" type="text" style="width: 500px;">
    <button id="saveTokenButton">í† í° ì €ì¥</button>
</div>
<hr>

<!-- ì£¼ë¬¸ ì •ë³´ -->
<div>
    <label>ì£¼ë¬¸ ID (purchaseId): </label>
    <input id="purchaseId" type="number" placeholder="ì˜ˆ: 591">
</div>

<div>
    <label>ê²°ì œ ê¸ˆì•¡(ì›): </label>
    <input id="amount" type="number" value="10000">
</div>

<div>
    <label>ì£¼ë¬¸ ì´ë¦„: </label>
    <input id="orderName" type="text" value="ìƒí’ˆ ê²°ì œ">
</div>

<button id="payButton">í† ìŠ¤í˜ì´ë¨¼ì¸ ë¡œ ê²°ì œí•˜ê¸°</button>

<p id="log"></p>

<script src="https://js.tosspayments.com/v1"></script>
<script>
    const clientKey = "test_ck_P9BRQmyarYg55ZeE5b5X3J07KzLN";

    const saveTokenButton = document.getElementById("saveTokenButton");
    const accessTokenInput = document.getElementById("accessToken");
    const payButton = document.getElementById("payButton");
    const log = document.getElementById("log");

    // ì €ì¥ëœ í† í° ìë™ ë¡œë“œ
    (function loadToken() {
        const saved = localStorage.getItem("accessToken");
        if (saved) accessTokenInput.value = saved;
    })();

    // í† í° ì €ì¥
    saveTokenButton.addEventListener("click", () => {
        const token = accessTokenInput.value.trim();
        if (!token) {
            alert("í† í°ì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }
        localStorage.setItem("accessToken", token);
        alert("í† í° ì €ì¥ ì™„ë£Œ!");
    });

    // ê²°ì œ ë²„íŠ¼ í´ë¦­ â†’ initiate â†’ paymentId â†’ toss requestPayment
    payButton.addEventListener("click", async () => {
        try {
            const token = accessTokenInput.value.trim() || localStorage.getItem("accessToken");
            if (!token) {
                alert("JWT í† í°ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.");
                return;
            }

            const purchaseId = Number(document.getElementById("purchaseId").value);
            const amount = Number(document.getElementById("amount").value);
            const orderName = document.getElementById("orderName").value;

            if (!purchaseId) {
                alert("ì£¼ë¬¸ ID(purchaseId)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            // ğŸ”¥ [1] ê²°ì œ ì´ˆê¸°í™” â†’ paymentId ìƒì„±
            const initiateResponse = await fetch("/api/v1/payments/initiate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                    purchaseId: purchaseId,
                    paymentType: "PAYMENT",
                    amount: amount
                })
            });

            if (!initiateResponse.ok) {
                const err = await initiateResponse.text();
                throw new Error("ê²°ì œ ì´ˆê¸°í™” ì‹¤íŒ¨: " + err);
            }

            const initJson = await initiateResponse.json();
            const paymentId = initJson.data.paymentId;

            // orderId = paymentId íŒ¨ë”©í•œ ê°’
            const orderIdForToss = String(paymentId).padStart(6, "0");

            log.innerText = `ê²°ì œ ì´ˆê¸°í™” ì„±ê³µ â†’ paymentId=${paymentId}`;

            // ğŸ”¥ [2] í† ìŠ¤ ê²°ì œì°½ í˜¸ì¶œ
            const tossPayments = TossPayments(clientKey);

            await tossPayments.requestPayment("CARD", {
                amount: amount,
                orderId: orderIdForToss,
                orderName: orderName,
                successUrl: window.location.origin + "/success.html",
                failUrl: window.location.origin + "/fail.html"
            });

        } catch (e) {
            console.error(e);
            log.innerText = "ì—ëŸ¬ ë°œìƒ: " + e.message;
        }
    });
</script>

</body>
</html>
